name: Repo Research Agent - Cloud Execution

on:
  workflow_dispatch:
    inputs:
      github_owner:
        description: 'GitHub Owner/Organization'
        required: false
        default: 'matiasportugau-ui'
      workspace_path:
        description: 'Workspace path to analyze'
        required: false
        default: '.'
  schedule:
    # Ejecutar diariamente a las 2 AM UTC
    - cron: '0 2 * * *'
  push:
    branches:
      - main
    paths:
      - 'repo_research_agent.py'
      - 'local_repo_research_agent.py'
      - '.github/workflows/repo-research-cloud.yml'

jobs:
  research:
    runs-on: ubuntu-latest
    name: InvestigaciÃ³n de Repositorios iOS
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pygithub
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
      
      - name: Configure GitHub Token
        run: |
          if [ -z "${{ secrets.GITHUB_TOKEN }}" ]; then
            echo "âš ï¸  GITHUB_TOKEN no configurado en secrets"
          else
            echo "âœ… GITHUB_TOKEN configurado"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Run Local Research Agent
        id: research
        run: |
          echo "ðŸš€ Iniciando investigaciÃ³n de repositorios iOS..."
          python3 local_repo_research_agent.py \
            --workspace "${{ github.event.inputs.workspace_path || '.' }}" \
            --github-owner "${{ github.event.inputs.github_owner || 'matiasportugau-ui' }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_OWNER: ${{ github.event.inputs.github_owner || 'matiasportugau-ui' }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      
      - name: Upload Research Report
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: research-report-${{ github.run_number }}
          path: |
            local_research_report_*.json
            local_execution_*.json
          retention-days: 30
      
      - name: Create Summary Comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // Buscar archivo de reporte
            const files = fs.readdirSync('.');
            const reportFile = files.find(f => f.startsWith('local_research_report_'));
            
            if (reportFile) {
              const report = JSON.parse(fs.readFileSync(reportFile, 'utf8'));
              const summary = report.summary || {};
              
              const comment = `## ðŸ“Š Reporte de InvestigaciÃ³n de Repositorios iOS
              
              **Execution ID:** \`${report.execution_id || 'N/A'}\`
              
              ### Resultados:
              - âœ… Repositorios iOS encontrados: ${summary.total_repos || 0}
              - âœ… MÃ³dulos en workspace: ${summary.total_modules || 0}
              - âœ… Mejoras identificadas: ${summary.total_improvements || 0}
              - âœ… Fases en plan: ${summary.plan_phases || 0}
              
              ðŸ“„ [Ver reporte completo](${reportFile})
              `;
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }
      
      - name: Upload Results to GitHub
        if: success()
        uses: actions/upload-artifact@v3
        with:
          name: research-results
          path: |
            local_research_report_*.json
            local_execution_*.json
