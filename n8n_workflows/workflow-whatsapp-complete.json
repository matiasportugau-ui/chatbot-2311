{
  "name": "BMC WhatsApp Complete Flow",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "GET",
        "path": "webhook/whatsapp",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-verify",
      "name": "Webhook Verify (GET)",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [240, 300],
      "webhookId": "bmc-whatsapp-verify"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "webhook/whatsapp",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-post",
      "name": "Webhook WhatsApp (POST)",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [240, 500],
      "webhookId": "bmc-whatsapp-post"
    },
    {
      "parameters": {
        "functionCode": "// Verify webhook signature (X-Hub-Signature-256)\nconst crypto = require('crypto');\nconst secret = $env.WHATSAPP_VERIFY_TOKEN || 'your-secret-token';\nconst signature = $input.item.json.headers['x-hub-signature-256'];\nconst body = JSON.stringify($input.item.json.body);\n\nif (!signature) {\n  return {\n    json: {\n      error: \"Missing signature\",\n      verified: false\n    }\n  };\n}\n\n// Calculate expected signature\nconst expectedSignature = 'sha256=' + crypto\n  .createHmac('sha256', secret)\n  .update(body)\n  .digest('hex');\n\n// Compare signatures (constant-time)\nconst verified = crypto.timingSafeEqual(\n  Buffer.from(signature),\n  Buffer.from(expectedSignature)\n);\n\nreturn {\n  json: {\n    verified: verified,\n    body: $input.item.json.body\n  }\n};"
      },
      "id": "verify-signature",
      "name": "Verify Signature",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [460, 500]
    },
    {
      "parameters": {
        "functionCode": "// Extract message data from WhatsApp webhook\nconst body = $input.item.json.body;\n\n// Handle GET request (verification)\nif ($input.item.json.method === 'GET') {\n  const mode = $input.item.json.query['hub.mode'];\n  const token = $input.item.json.query['hub.verify_token'];\n  const challenge = $input.item.json.query['hub.challenge'];\n  \n  if (mode === 'subscribe' && token === $env.WHATSAPP_VERIFY_TOKEN) {\n    return {\n      json: {\n        verified: true,\n        challenge: challenge\n      }\n    };\n  }\n  \n  return {\n    json: {\n      verified: false\n    }\n  };\n}\n\n// Handle POST request (messages)\nif (!body.entry || !body.entry[0] || !body.entry[0].changes) {\n  return {\n    json: {\n      error: \"Invalid webhook structure\",\n      success: false\n    }\n  };\n}\n\nconst change = body.entry[0].changes[0];\nconst value = change.value;\n\n// Check if it's a message\nif (!value.messages || value.messages.length === 0) {\n  return {\n    json: {\n      error: \"No messages in webhook\",\n      success: false\n    }\n  };\n}\n\nconst message = value.messages[0];\nconst contact = value.contacts ? value.contacts[0] : null;\n\n// Extract message text\nlet messageText = '';\nif (message.type === 'text' && message.text) {\n  messageText = message.text.body;\n} else {\n  messageText = \"[Mensaje no soportado: \" + message.type + \"]\";\n}\n\nreturn {\n  json: {\n    message: messageText,\n    phone: message.from,\n    messageId: message.id,\n    timestamp: message.timestamp,\n    contactName: contact ? contact.profile.name : \"Usuario\",\n    waId: value.metadata ? value.metadata.phone_number_id : null,\n    success: true\n  }\n};"
      },
      "id": "extract-message",
      "name": "Extract Message",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [680, 500]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "check-verified",
              "leftValue": "={{ $json.verified }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "check-verified",
      "name": "Signature Verified?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [900, 500]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.PY_CHAT_SERVICE_URL || 'http://chat-api:8000' }}/chat/process",
        "authentication": "none",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "mensaje",
              "value": "={{ $json.message }}"
            },
            {
              "name": "telefono",
              "value": "={{ $json.phone }}"
            },
            {
              "name": "sesionId",
              "value": "={{ 'wa_' + $json.phone + '_' + Date.now() }}"
            }
          ]
        },
        "options": {
          "timeout": 30000
        }
      },
      "id": "call-python-api",
      "name": "Call Python API",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1120, 500]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "check-type",
              "leftValue": "={{ $json.tipo }}",
              "rightValue": "cotizacion",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "check-quote-type",
      "name": "Is Quote Type?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [1340, 500]
    },
    {
      "parameters": {
        "operation": "insertOne",
        "collection": "conversations",
        "fields": {
          "mappingMode": "defineBelow",
          "value": {
            "session_id": "={{ $json.sesion_id }}",
            "phone": "={{ $('Extract Message').item.json.phone }}",
            "contact_name": "={{ $('Extract Message').item.json.contactName }}",
            "message": "={{ $('Extract Message').item.json.message }}",
            "response": "={{ $json.mensaje }}",
            "type": "={{ $json.tipo }}",
            "confidence": "={{ $json.confianza }}",
            "timestamp": "={{ new Date().toISOString() }}",
            "message_id": "={{ $('Extract Message').item.json.messageId }}",
            "source": "whatsapp"
          }
        },
        "options": {}
      },
      "id": "save-mongodb",
      "name": "Save to MongoDB",
      "type": "n8n-nodes-base.mongoDb",
      "typeVersion": 1,
      "position": [1560, 500],
      "credentials": {
        "mongoDb": {
          "id": "mongodb-credentials",
          "name": "MongoDB"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v19.0/{{ $env.WHATSAPP_PHONE_NUMBER_ID }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "messaging_product",
              "value": "whatsapp"
            },
            {
              "name": "to",
              "value": "={{ $('Extract Message').item.json.phone }}"
            },
            {
              "name": "type",
              "value": "text"
            },
            {
              "name": "text",
              "value": "={{ { body: $json.mensaje } }}"
            }
          ]
        },
        "options": {}
      },
      "id": "send-whatsapp",
      "name": "Send WhatsApp Reply",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1780, 500],
      "credentials": {
        "httpHeaderAuth": {
          "id": "whatsapp-auth",
          "name": "WhatsApp API"
        }
      }
    },
    {
      "parameters": {
        "functionCode": "// Error handler - log and notify\nconst error = $input.item.json.error || $input.item.json;\n\nreturn {\n  json: {\n    error: error.message || error,\n    timestamp: new Date().toISOString(),\n    phone: $('Extract Message') ? $('Extract Message').item.json.phone : 'unknown',\n    source: \"whatsapp-webhook\"\n  }\n};"
      },
      "id": "error-handler",
      "name": "Error Handler",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1340, 700]
    },
    {
      "parameters": {
        "operation": "insertOne",
        "collection": "error_logs",
        "fields": {
          "mappingMode": "defineBelow",
          "value": {
            "error": "={{ $json.error }}",
            "timestamp": "={{ $json.timestamp }}",
            "phone": "={{ $json.phone }}",
            "source": "={{ $json.source }}"
          }
        },
        "options": {}
      },
      "id": "save-error",
      "name": "Save Error to DLQ",
      "type": "n8n-nodes-base.mongoDb",
      "typeVersion": 1,
      "position": [1560, 700],
      "credentials": {
        "mongoDb": {
          "id": "mongodb-credentials",
          "name": "MongoDB"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { status: 'ok', message: 'Webhook verified' } }}"
      },
      "id": "respond-verify",
      "name": "Respond Verify",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [460, 300]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { status: 'ok', message: 'Message processed' } }}"
      },
      "id": "respond-ok",
      "name": "Respond OK",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [2000, 500]
    }
  ],
  "connections": {
    "Webhook Verify (GET)": {
      "main": [
        [
          {
            "node": "Respond Verify",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook WhatsApp (POST)": {
      "main": [
        [
          {
            "node": "Verify Signature",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Verify Signature": {
      "main": [
        [
          {
            "node": "Extract Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Message": {
      "main": [
        [
          {
            "node": "Check Verified",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Verified": {
      "main": [
        [
          {
            "node": "Call Python API",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Error Handler",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Call Python API": {
      "main": [
        [
          {
            "node": "Check Quote Type",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Quote Type": {
      "main": [
        [
          {
            "node": "Save to MongoDB",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Save to MongoDB",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save to MongoDB": {
      "main": [
        [
          {
            "node": "Send WhatsApp Reply",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send WhatsApp Reply": {
      "main": [
        [
          {
            "node": "Respond OK",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Error Handler": {
      "main": [
        [
          {
            "node": "Save Error to DLQ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 0,
  "updatedAt": "2024-01-01T00:00:00.000Z",
  "versionId": "1"
}

