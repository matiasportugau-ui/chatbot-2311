---
# External Secrets Operator configuration for Google Secret Manager
# Prerequisites:
# 1. Install External Secrets Operator: https://external-secrets.io/latest/introduction/getting-started/
# 2. Configure GCP Workload Identity or Service Account
# 3. Create secrets in Google Secret Manager with the names below
---
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: gcpsm-secret-store
  namespace: bmc-chatbot
spec:
  provider:
    gcpsm:
      projectID: "PROJECT_ID"  # Replace with your GCP project ID
      auth:
        workloadIdentity:
          clusterLocation: us-central1
          clusterName: bmc-chatbot-cluster
          serviceAccountRef:
            name: external-secrets-sa
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: bmc-chatbot-secrets
  namespace: bmc-chatbot
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: gcpsm-secret-store
    kind: SecretStore
  target:
    name: bmc-chatbot-secrets
    creationPolicy: Owner
  data:
    # OpenAI API Key
    - secretKey: OPENAI_API_KEY
      remoteRef:
        key: openai-api-key
    
    # Groq API Key (for alternative LLM)
    - secretKey: GROQ_API_KEY
      remoteRef:
        key: groq-api-key
    
    # Gemini API Key (for alternative LLM)
    - secretKey: GEMINI_API_KEY
      remoteRef:
        key: gemini-api-key
    
    # WhatsApp Business API
    - secretKey: WHATSAPP_ACCESS_TOKEN
      remoteRef:
        key: whatsapp-token
    
    - secretKey: WHATSAPP_VERIFY_TOKEN
      remoteRef:
        key: whatsapp-verify-token
    
    - secretKey: WHATSAPP_PHONE_NUMBER_ID
      remoteRef:
        key: whatsapp-phone-number-id
    
    # MongoDB Connection
    - secretKey: MONGODB_URI
      remoteRef:
        key: mongodb-uri
    
    # N8N Webhook Integration
    - secretKey: N8N_WEBHOOK_URL
      remoteRef:
        key: n8n-webhook-url
    
    - secretKey: N8N_API_KEY
      remoteRef:
        key: n8n-api-key
    
    # PostgreSQL (if used for analytics/logs)
    - secretKey: POSTGRES_URI
      remoteRef:
        key: postgres-uri
    
    # Admin Credentials
    - secretKey: ADMIN_PASSWORD
      remoteRef:
        key: admin-password
    
    # Google Sheets Integration
    - secretKey: GOOGLE_SHEETS_CREDENTIALS
      remoteRef:
        key: google-sheets-credentials
    
    - secretKey: GOOGLE_SHEET_ID
      remoteRef:
        key: google-sheet-id
---
# Service Account for External Secrets Operator
apiVersion: v1
kind: ServiceAccount
metadata:
  name: external-secrets-sa
  namespace: bmc-chatbot
  annotations:
    iam.gke.io/gcp-service-account: external-secrets@PROJECT_ID.iam.gserviceaccount.com
