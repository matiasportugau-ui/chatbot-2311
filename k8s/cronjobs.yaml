---
# CronJob: Product Mapper - Daily at 3 AM UTC
# Maps BMC products with their web links from bmcuruguay.com.uy
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: product-mapper
  namespace: bmc-chatbot
  labels:
    app.kubernetes.io/name: product-mapper
    app.kubernetes.io/component: cronjob
    app.kubernetes.io/part-of: bmc-chatbot
spec:
  schedule: "0 3 * * *"  # Daily at 3 AM UTC
  timeZone: "UTC"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    metadata:
      labels:
        app.kubernetes.io/name: product-mapper-job
        app.kubernetes.io/component: cronjob
    spec:
      backoffLimit: 3
      template:
        metadata:
          labels:
            app.kubernetes.io/name: product-mapper-job
        spec:
          serviceAccountName: bmc-chatbot-sa
          restartPolicy: OnFailure
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            fsGroup: 1000
          containers:
          - name: product-mapper
            image: us-central1-docker.pkg.dev/PROJECT_ID/bmc-chatbot/agents:latest
            imagePullPolicy: Always
            command: ["python", "-u", "mapeador_productos_web.py"]
            env:
            - name: ENVIRONMENT
              value: "production"
            - name: LOG_LEVEL
              value: "INFO"
            - name: MONGODB_URI
              valueFrom:
                secretKeyRef:
                  name: bmc-chatbot-secrets
                  key: MONGODB_URI
            - name: OPENAI_API_KEY
              valueFrom:
                secretKeyRef:
                  name: bmc-chatbot-secrets
                  key: OPENAI_API_KEY
            resources:
              requests:
                memory: "256Mi"
                cpu: "250m"
                ephemeral-storage: "1Gi"
              limits:
                memory: "512Mi"
                cpu: "500m"
                ephemeral-storage: "2Gi"
            securityContext:
              allowPrivilegeEscalation: false
              capabilities:
                drop:
                - ALL
              readOnlyRootFilesystem: false
---
# CronJob: Follow-up Agent - Every 2 hours
# Sends automated follow-ups to customers
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: followup-agent
  namespace: bmc-chatbot
  labels:
    app.kubernetes.io/name: followup-agent
    app.kubernetes.io/component: cronjob
    app.kubernetes.io/part-of: bmc-chatbot
spec:
  schedule: "0 */2 * * *"  # Every 2 hours
  timeZone: "UTC"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    metadata:
      labels:
        app.kubernetes.io/name: followup-agent-job
        app.kubernetes.io/component: cronjob
    spec:
      backoffLimit: 2
      template:
        metadata:
          labels:
            app.kubernetes.io/name: followup-agent-job
        spec:
          serviceAccountName: bmc-chatbot-sa
          restartPolicy: OnFailure
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            fsGroup: 1000
          containers:
          - name: followup-agent
            image: us-central1-docker.pkg.dev/PROJECT_ID/bmc-chatbot/agents:latest
            imagePullPolicy: Always
            command: ["python", "-u", "background_agent_followup.py"]
            env:
            - name: ENVIRONMENT
              value: "production"
            - name: LOG_LEVEL
              value: "INFO"
            - name: MONGODB_URI
              valueFrom:
                secretKeyRef:
                  name: bmc-chatbot-secrets
                  key: MONGODB_URI
            - name: OPENAI_API_KEY
              valueFrom:
                secretKeyRef:
                  name: bmc-chatbot-secrets
                  key: OPENAI_API_KEY
            - name: WHATSAPP_ACCESS_TOKEN
              valueFrom:
                secretKeyRef:
                  name: bmc-chatbot-secrets
                  key: WHATSAPP_ACCESS_TOKEN
                  optional: true
            - name: WHATSAPP_PHONE_NUMBER_ID
              valueFrom:
                secretKeyRef:
                  name: bmc-chatbot-secrets
                  key: WHATSAPP_PHONE_NUMBER_ID
                  optional: true
            - name: N8N_WEBHOOK_URL
              valueFrom:
                secretKeyRef:
                  name: bmc-chatbot-secrets
                  key: N8N_WEBHOOK_URL
                  optional: true
            resources:
              requests:
                memory: "512Mi"
                cpu: "500m"
                ephemeral-storage: "1Gi"
              limits:
                memory: "1Gi"
                cpu: "1000m"
                ephemeral-storage: "2Gi"
            securityContext:
              allowPrivilegeEscalation: false
              capabilities:
                drop:
                - ALL
              readOnlyRootFilesystem: false
---
# CronJob: Repository Research Agent - Daily at 2 AM UTC
# Analyzes repository and generates improvement plans
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: repo-research
  namespace: bmc-chatbot
  labels:
    app.kubernetes.io/name: repo-research
    app.kubernetes.io/component: cronjob
    app.kubernetes.io/part-of: bmc-chatbot
spec:
  schedule: "0 2 * * *"  # Daily at 2 AM UTC
  timeZone: "UTC"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    metadata:
      labels:
        app.kubernetes.io/name: repo-research-job
        app.kubernetes.io/component: cronjob
    spec:
      backoffLimit: 3
      template:
        metadata:
          labels:
            app.kubernetes.io/name: repo-research-job
        spec:
          serviceAccountName: bmc-chatbot-sa
          restartPolicy: OnFailure
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            fsGroup: 1000
          containers:
          - name: repo-research
            image: us-central1-docker.pkg.dev/PROJECT_ID/bmc-chatbot/agents:latest
            imagePullPolicy: Always
            command: ["python", "-u", "local_repo_research_agent.py"]
            env:
            - name: ENVIRONMENT
              value: "production"
            - name: LOG_LEVEL
              value: "INFO"
            - name: MONGODB_URI
              valueFrom:
                secretKeyRef:
                  name: bmc-chatbot-secrets
                  key: MONGODB_URI
            - name: OPENAI_API_KEY
              valueFrom:
                secretKeyRef:
                  name: bmc-chatbot-secrets
                  key: OPENAI_API_KEY
            - name: GITHUB_TOKEN
              valueFrom:
                secretKeyRef:
                  name: bmc-chatbot-secrets
                  key: GITHUB_TOKEN
                  optional: true
            resources:
              requests:
                memory: "512Mi"
                cpu: "500m"
                ephemeral-storage: "2Gi"
              limits:
                memory: "1Gi"
                cpu: "1000m"
                ephemeral-storage: "4Gi"
            securityContext:
              allowPrivilegeEscalation: false
              capabilities:
                drop:
                - ALL
              readOnlyRootFilesystem: false
